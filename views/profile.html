<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>โปรไฟล์ผู้ใช้</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
      }

      .container {
        width: 400px;
        margin: 80px auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .profile {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #007bff;
        margin-bottom: 20px;
      }

      button {
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }

      .logout-btn {
        background: #dc3545;
        color: white;
      }

      .edit-btn {
        background: #007bff;
        color: white;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <img
        id="profile-img"
        class="profile"
        src="https://via.placeholder.com/120"
        alt="Profile Picture"
      />
      <h2 id="username">กำลังโหลด...</h2>
      <p id="email">...</p>
      <button class="edit-btn" onclick="editProfile()">แก้ไขโปรไฟล์</button>
      <button class="logout-btn" onclick="logout()">ออกจากระบบ</button>
    </div>

    <script>
      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("user"));

      if (!token || !user || !user.uid) {
        alert("กรุณาเข้าสู่ระบบก่อน");
        window.location.href = "login.html";
      }

      async function loadUser() {
        try {
          const res = await fetch(
            `https://games-database-main.onrender.com/user/${user.uid}`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.message || "ไม่สามารถโหลดข้อมูลได้");
          }

          document.getElementById("username").textContent =
            data.username || "ไม่พบชื่อผู้ใช้";
          document.getElementById("email").textContent =
            data.email || "ไม่พบอีเมล";

          const profileImg = document.getElementById("profile-img");

          if (
            data.profile &&
            typeof data.profile === "string" &&
            data.profile.trim() !== ""
          ) {
            try {
              const imageRes = await fetch(
                `https://games-database-main.onrender.com/uploads/${data.profile}`,
                {
                  headers: {
                    Authorization: `Bearer ${token}`,
                  },
                }
              );

              if (!imageRes.ok) throw new Error("โหลดรูปไม่สำเร็จ");

              const blob = await imageRes.blob();
              profileImg.src = URL.createObjectURL(blob);
            } catch (imgErr) {
              console.warn("⚠️ โหลดรูปไม่สำเร็จ:", imgErr);
              profileImg.src = "https://via.placeholder.com/120";
            }
          } else {
            profileImg.src = "https://via.placeholder.com/120";
          }
        } catch (err) {
          console.error("❌ Error loading user:", err);
          alert("โหลดข้อมูลผู้ใช้ไม่สำเร็จ: " + err.message);
        }
      }

      function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "login.html";
      }

      function editProfile() {
        window.location.href = `test_update.html?uid=${user.uid}`;
      }

      loadUser();
    </script>
  </body>
</html>
